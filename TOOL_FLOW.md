# Tool Execution Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Ralph Iteration Starts                          â”‚
â”‚                                                                     â”‚
â”‚  System Prompt + User: "Begin. Follow instructions."               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      LLM Generates Response                         â”‚
â”‚                                                                     â”‚
â”‚  "I'll read the PRD file to understand the tasks.                  â”‚
â”‚   {"name": "read_file", "arguments": {"path": "prd.json"}}"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ğŸ” CHUNK 1: Detect Tool Calls                          â”‚
â”‚                  (tool_parser.py)                                   â”‚
â”‚                                                                     â”‚
â”‚  extract_tool_calls(message, text)                                 â”‚
â”‚    â”œâ”€ Check for structured tool_calls (OpenAI format)              â”‚
â”‚    â””â”€ Fall back to text parsing:                                   â”‚
â”‚       â”œâ”€ JSON embedded: {"name": ..., "arguments": ...}            â”‚
â”‚       â”œâ”€ Multi-line: Tool: ... \n Arguments: ...                   â”‚
â”‚       â””â”€ Function style: tool_name({...})                          â”‚
â”‚                                                                     â”‚
â”‚  Result: [{"name": "read_file", "arguments": {"path": "prd.json"}}]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ğŸ”„ CHUNK 4: Deduplicate Tool Calls                     â”‚
â”‚                  (tool_parser.py)                                   â”‚
â”‚                                                                     â”‚
â”‚  deduplicate_tool_calls(calls, recent_history)                     â”‚
â”‚    â””â”€ Check if (tool_name, arguments) in last 10 calls             â”‚
â”‚    â””â”€ Filter exact duplicates                                      â”‚
â”‚                                                                     â”‚
â”‚  Recent: [("read_file", {"path": "prd.json"}), ...]                â”‚
â”‚  Result: [] if duplicate, [call] if unique                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               âš™ï¸  CHUNK 2: Execute Tool                             â”‚
â”‚                    (tools.py)                                       â”‚
â”‚                                                                     â”‚
â”‚  ToolExecutor.execute("read_file", {"path": "prd.json"})           â”‚
â”‚    â””â”€ _read_file(path)                                             â”‚
â”‚       â””â”€ file_path.read_text()                                     â”‚
â”‚                                                                     â”‚
â”‚  Result: "{                                                         â”‚
â”‚    \"projectName\": \"My Project\",                                 â”‚
â”‚    \"branchName\": \"ralph/feature-1\",                             â”‚
â”‚    \"userStories\": [...]                                           â”‚
â”‚  }"                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ğŸ’‰ CHUNK 3: Inject Tool Result                           â”‚
â”‚                (ralph_ollama.py)                                    â”‚
â”‚                                                                     â”‚
â”‚  messages.append({                                                  â”‚
â”‚    "role": "tool",                                                  â”‚
â”‚    "tool_call_id": "call_1",                                        â”‚
â”‚    "content": "TOOL RESULT (read_file):\n{...prd contents...}"     â”‚
â”‚  })                                                                 â”‚
â”‚                                                                     â”‚
â”‚  This makes the result VISIBLE to the model!                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  LLM Sees Tool Result                               â”‚
â”‚                                                                     â”‚
â”‚  "I can see the PRD has 3 stories. The first story is about...     â”‚
â”‚   Let me check the current branch:                                 â”‚
â”‚   {"name": "git_current_branch", "arguments": {}}"                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                         [Loop continues...]
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ğŸ“Š CHUNK 5: Check for Progress                              â”‚
â”‚                (tool_parser.py)                                     â”‚
â”‚                                                                     â”‚
â”‚  has_progress_markers(messages[-3:])                               â”‚
â”‚    â””â”€ Look for indicators in recent tool results:                  â”‚
â”‚       â”œâ”€ "Successfully wrote to"                                   â”‚
â”‚       â”œâ”€ "Committed:"                                              â”‚
â”‚       â”œâ”€ "Tests passed"                                            â”‚
â”‚       â””â”€ '"passes": true'                                          â”‚
â”‚                                                                     â”‚
â”‚  If NO progress for multiple steps â†’ Warn user                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


## Key Insights

### Without Tool Execution (Before)
```
User: Begin
  â†“
LLM: "Let me read prd.json" 
  â†“
[Nothing happens - tool not executed]
  â†“
LLM: "Please provide prd.json"
  â†“
[Still nothing happens]
  â†“
LLM: "I need the PRD file..."
  â†“
[Infinite loop - no progress]
```

### With Tool Execution (After)
```
User: Begin
  â†“
LLM: "Let me read prd.json"
  â†“
[Tool detected, executed, result injected]
  â†“
LLM: "I see 3 stories, let me implement story #1"
  â†“
[Tools executed: write_file, run_cmd, git_commit_all]
  â†“
LLM: "Story #1 complete. <promise>COMPLETE</promise>"
  â†“
[Progress made! âœ…]
```

## The Critical Difference

**Before**: Model talks ABOUT tools but never uses them  
**After**: Model talks AND ACTS with real tool execution

The model becomes an **agent**, not just a chatbot.
